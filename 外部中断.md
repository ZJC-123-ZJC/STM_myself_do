# 外部中断

创作者：张锦程

时间2021.8.1

以下笔记大部分摘自b站up主：**成电应电科协，小蜜蜂老师，野火**

实战使用开发板：正点原子stm32f103mini（芯片为stm32f103rct6）

## 基本概念概述：

### STM32与外设的数据传输方式：

![image-20210728214844359](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728214844359.png)



### 中断处理过程：

![image-20210728214917174](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728214917174.png)

------

### 中断优先级：

1. 已经有中断在工作。根据抢占优先级决定，新来的中断打不打断原有中断，打断就发生中断嵌套，不打断就挂起等着。

2. 中断都在挂起等待的状态，先按抢占优先级排序，抢占优先级高的先行。若抢占优先级相同，就按子优先级排序，子优先级高的先行。

   若子优先级还相同，就按IRQ编号小的先行。

   （IRQ编号在system_stmf1xx.c中的对应芯片的头文件中）

所以：抢占优先级 > 子优先级 > IRQ编号

​	可编程的优先级，通过嵌套向量中断控制器（NVIC）实现           

![image-20210728215007621](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728215007621.png)          

![image-20210728220055313](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220055313.png)



![image-20210728220149862](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220149862.png)

------

------



### 中断的作用总结:

![image-20210728214954256](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728214954256.png)

------

### 中断向量与中断服务程序概念：

中断向量表一般在启动文件中，以汇编语言实现。

![image-20210728215030805](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728215030805.png)

### 查找中断向量表：

![image-20210728215930970](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728215930970.png)

------

### 中断响应过程：

![image-20210728220033136](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220033136.png)

------



------

### 补充：

事件的概念：内部信号可理解为事件。

事件的可不可见区分：具体体现在寄存器里可不可以查到这些事件的标志

事件------->中断 or 事件------->事件

------

## EXTI-扩展中断和事件控制器：

### 概述：

![image-20210728220230026](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220230026.png)

1. 是STM32上的一个外设，可以捕获外部输入线电平变化等等一些事件。EXTI捕获到了事件后，还可以生成相应的EXTI中断及等等的一些中断。
2. EXIT外设大致概括为以下两个功能
   1. 捕获外部输入等事件
   2. 生成EXTI中断等中断请求

![image-20210728220210047](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220210047.png)

 

理解上面这张图，可以了解EXTI的大概脉络

也可见外部中断触发条件大致为以下三种:

1. 上升沿触发
2. 下降沿触发
3. 双边沿触发

注意：不能配置成高电平触发和低电平触发

### 引脚分组：

![image-20210728220304453](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220304453.png)

------

## 程序编写思路：

### 中断程序编写步骤：

![image-20210728220318065](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220318065.png)

传统STM32外部中断设计步骤：

1. 将GPIO初始化为输入端口
2. 配置相关I/O引脚与中断线的映射关系
3. 设置该I/O引脚对应的中断触发条件
4. 配置NVIC，并使能中断
5. 编写中断服务函数

时代变了！

基于STM32CubeMX的外部中断设计步骤：

1. 在STM32CubeMX中指定引脚，配置中断初始化参数
2. **重写该I/O引脚对应的中断回调函数（在中断文件中）**





注意：配置中断优先级时，大多数情况采用默认的即可

![image-20210731233433144](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210731233433144.png)

------



### HAL库函数封装：

### ![image-20210728220340497](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220340497.png)

### 启动文件：

![image-20210728220352716](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220352716.png)

weak类似于C++中的虚函数，重写该函数类似于重写虚函数（多态）

### 中断文件：

![image-20210728220400590](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210728220400590.png)

## 外部中断处理流程（程序编写）：

![image-20210731233408358](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210731233408358.png)

主要是重写回调函数，重写入main函数中

![img](https://www.xmf393.com/wp-content/uploads/2020/02/%E4%B8%AD%E6%96%AD%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0.png)

## 实战：外部中断法点亮LED灯

1. 使用CubeMX配置引脚

该例采用双边沿触发模式KEY0 -> PC5，LED0 -> DS0 -> PA8

2. 配置完毕，重写回调函数

   ![image-20210731214246686](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210731214246686.png)

可看到回调函数所在处

重写回调函数

```c
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
	if(HAL_GPIO_ReadPin(KEY0_GPIO_Port,KEY0_Pin)==0)
	{
		HAL_Delay(100);
		if(HAL_GPIO_ReadPin(KEY0_GPIO_Port,KEY0_Pin)==0)
		{	
			HAL_GPIO_TogglePin(LED0_GPIO_Port,LED0_Pin);
            while(!HAL_GPIO_ReadPin(KEY0_GPIO_Port,KEY0_Pin));
		}
	}
}
```

下面这种更规范

```c
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
	if(GPIO_Pin == KEY0_Pin)
	{
		HAL_Delay(100); // 延时消抖
		if(HAL_GPIO_ReadPin(KEY0_GPIO_Port,KEY0_Pin)==GPIO_PIN_RESET)
		{	
			HAL_GPIO_TogglePin(LED0_GPIO_Port,LED0_Pin);
            while(!HAL_GPIO_ReadPin(KEY0_GPIO_Port,KEY0_Pin));
		}
	}
}	
```

发现前两种都无法实现按下按键转换灯模式

用以下方式写才成功

```c
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
	if(GPIO_Pin == KEY0_Pin)
	{
			HAL_GPIO_TogglePin(LED0_GPIO_Port,LED0_Pin);
	}
}	
```

若有多个中断，则采用switch语法

![image-20210731233016163](C:\Users\张aa\AppData\Roaming\Typora\typora-user-images\image-20210731233016163.png)

